version: 2.1

jobs:
  build:
    docker:
      - image: docker:stable  # Based on Alpine, lightweight

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Install curl and Docker Compose V2 plugin
          command: |
            apk add --no-cache curl
            mkdir -p ~/.docker/cli-plugins/
            curl -SL https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
            chmod +x ~/.docker/cli-plugins/docker-compose
            docker compose version


      - run:
          name: Pull and build images
          command: |
            docker compose pull postgresdb
            docker compose build app
          no_output_timeout: 10m

      - run:
          name: Start services
          command: |
            docker compose up -d || {
              echo "=== Docker Compose failed to start, showing logs ==="
              docker compose logs
              docker compose ps -a
              exit 1
            }

      - run:
          name: Show postgresdb logs in background
          background: true
          command: |
            docker compose logs -f postgresdb

      - run:
          name: Wait for postgresdb to be healthy
          command: |
            echo "Waiting for 'postgresdb' to be healthy..."
            timeout=180
            while [ "$timeout" -gt 0 ]; do
              cid=$(docker compose ps -q postgresdb)
              status=$(docker inspect --format='{{.State.Health.Status}}' "$cid")
              echo "Health status: $status"
              if [ "$status" = "healthy" ]; then
                echo "Postgres is healthy!"
                break
              fi
              sleep 2
              timeout=$((timeout - 2))
            done

            if [ "$timeout" -le 0 ]; then
              echo "Postgres healthcheck timed out"
              echo "=== Showing all logs ==="
              docker compose logs
              echo "=== Showing postgresdb only ==="
              docker compose logs postgresdb
              echo "=== Container status ==="
              docker compose ps -a
              echo "=== Checking postgresdb health ==="
              cid=$(docker compose ps -q postgresdb)
              docker inspect "$cid" | grep -A 5 Health || echo "No health status found"
              exit 1
            fi

      - run:
          name: Run tests in /app
          command: docker compose exec app sh -c "cd /app && npm test"

      - run:
          name: Teardown
          when: always
          command: |
            docker compose down
            

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
