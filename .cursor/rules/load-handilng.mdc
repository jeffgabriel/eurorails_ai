---
description: Load management and demand card handling
globs: 
alwaysApply: false
---
### âœ… **Eurorails Load Management â€“ Contextual Design Rules for Code Generation**

#### ğŸ§  **Core Concepts & Responsibilities**

- A **Train** object can **carry loads**, has a **capacity**, and can **move across the map**.
- A **LoadChip** is a physical token representing a **type of good**. It can exist:
  - On a train
  - In a city
  - In the tray (available pool)
- A **City** may offer **specific load types** for pickup.
- A **DemandCard** links a **destination city** to up to **3 specific load types** and a **payoff amount**.
- The **Bank** manages:
  - The money supply
  - The pool of available load chips
  - Demand card deck and drawing

---

### ğŸ—ï¸ **Design Rule Categories**

---

#### 1. ğŸ™ï¸ **Load Pickup Rules**

- âœ… A train can **pick up a load** only if:
  - It is **currently on** a city that **produces** that load.
  - The **load chip is available** in the tray (i.e., not already in use).
  - The train has **remaining capacity** (â‰¤ 2 or 3 loads depending on train type).
- âœ… Players **do NOT need a Demand card** to pick up a load.
- ğŸ” Picking up a load does **not consume movement**.
- ğŸ§¾ Load pickup should be recorded in the trainâ€™s `currentLoads[]` array and removed from the tray.

---

#### 2. ğŸšš **Load Delivery Rules**

- âœ… A player may **deliver a load** if:
  - The train is **at a city** listed on a **Demand card**.
  - The load matches **one of the three load types** on that card.
- âœ… Delivery process:
  - Discard the Demand card.
  - Return the load chip to the tray.
  - Add the cardâ€™s payout to the playerâ€™s money.
  - Draw a new Demand card to maintain a hand of 3.
- â›” A single Demand card may only be used for **one delivery**, even if the train has multiple matching loads.

---

#### 3. ğŸ›‘ **Load Dropping Rules**

- âœ… A player may **drop a load** at **any city**, even if itâ€™s not demanded.
  - If the city produces that load â†’ the load goes back to the tray.
  - If it doesnâ€™t â†’ the load stays in that city.
  - If a load is already present in that city:
    - The **existing load is returned to the tray**
    - The **new load replaces it**

---

#### 4. ğŸš‚ **Train Constraints**

- âœ… Train capacity:
  - Freight / Fast Freight â†’ 2 loads
  - Heavy Freight / Superfreight â†’ 3 loads
- âœ… Movement limits:
  - Freight / Heavy â†’ 9 mileposts/turn
  - Fast / Super â†’ 12 mileposts/turn
- âœ… Picking up, dropping, or delivering a load does **not reduce movement**.

---

#### 5. ğŸ§  **Demand Card Rules**

- âœ… Each player must **always hold exactly 3 Demand cards**.
- âœ… When delivering a load or losing a card (e.g., Event), the player must:
  - Immediately draw a replacement, **even outside their own turn**.
- âœ… Demand cards list:
  - One city
  - Three load types
  - A payoff amount for delivery of any one of the listed loads to that city

---

#### 6. ğŸš¨ **Event Interactions**

- â— Event cards may cause load loss (e.g., **Derailment**):
  - If a train loses a load, the **player chooses which one**.
  - The lost load is returned to the tray.
- â— Delivery and pickup are blocked in certain events (e.g., **Strike!**).

---

#### 7. â™»ï¸ **Load Chip Lifecycle**

```plaintext
Tray â†’ City (setup/drop) â†’ Train (pickup) â†’ Tray (delivery/loss/drop)
```

- Loads should never be **duplicated**; the pool is fixed and finite.
- Dropping a load must respect **city slot constraints** (max 1 load per city).

---

#### 8. ğŸ§± **Code Style / Implementation Guidelines**

- Prefer **explicit state** tracking for:
  - LoadChip location (`'tray'`, `'train'`, `'city:<name>'`)
  - Train inventory (`Train.currentLoads[]`)
  - Player hand (`Player.demandCards[]`)
- Validate all actions with **guard clauses** or **`canX` methods**:
  - `canPickUp(load: LoadChip, city: City, train: Train): boolean`
  - `canDeliver(load: LoadChip, city: City, card: DemandCard): boolean`
- Use **pure functions** to enforce business rules where possible.
- Favor **event-sourced** logging if implementing audit/history (optional but useful for testing).

---

### âœ… Example Usage Patterns

```ts
if (canPickUp(load, currentCity, player.train)) {
  pickUpLoad(load, player.train, bank.tray)
}
```

```ts
if (canDeliver(load, currentCity, demandCard)) {
  deliverLoad(load, player, demandCard, bank)
}
```

---
